{% extends "catalog/base.html" %}
{% load static %}
{% load my_filters %}

{% block content %}
<section class="section section-cart">
    <div class="fake fake2"><br></div>

    {% if user.is_authenticated %}
        {% if cart_items %}
        <div class="cart-big-group">
            <!-- –õ–µ–≤—ã–π –±–ª–æ–∫: –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div class="cart-group cart-group1">
                <h3 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h3>
                <p class="cart-count">{{ total_quantity }} {{ total_quantity|pluralize_—Ç–æ–≤–∞—Ä }}</p>

                {% for item in cart_items %}
                <div class="cart-grid">
                    <div class="cart-flex-group">
                        <a href="{% url 'catalog:product_detail' item.product.id %}">
                            <img class="cart-img" src="{{ item.product.imgg.url }}" alt="{{ item.product.title }}"
                                 style="{% if not item.product.statuss or not item.is_size_available or item.quantity > item.stock_quantity %}filter: grayscale(100%); opacity: 0.6;{% endif %}" />
                        </a>
                        <div class="cart-flex-column">
                            <div class="cart-text-flex-column">
                                <a href="{% url 'catalog:product_detail' item.product.id %}"><p class="cart-text-title">{{ item.product.title }}</p></a>

                                {% if not item.product.statuss %}
                                    <p class="cart-text-subtitle" style="color: #e53935; font-weight: 600;">–¢–æ–≤–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</p>
                                {% elif not item.is_size_available %}
                                    <p class="cart-text-subtitle" style="color: #e53935; font-weight: 600;">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</p>
                                {% elif item.quantity > item.stock_quantity %}
                                    <p class="cart-text-subtitle" style="color: #e53935; font-weight: 600;">–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ {{ item.stock_quantity }} —à—Ç.</p>
                                {% endif %}

                                <p class="cart-text-subtitle">{{ item.product.colorr }}</p>
                                <p class="cart-text-subtitle">–†–∞–∑–º–µ—Ä: {{ item.size.name }}</p>
                            </div>
                            <div class="icons-cart-group">
                                <a href="#" class="favorite-btns {% if item.product.id in favorite_ids %}in-favorites{% endif %} favorite-btnss"
                                   id="favorite-btn-{{ item.product.id }}"
                                   onclick="toggleFavorite({{ item.product.id }}, this, '{{ csrf_token }}')">
                                    <span class="heart-icons heart-icon">‚ù§</span>
                                    <span class="favorite-text" style="display: none;"></span>
                                </a>
                                <a href="{% url 'catalog:remove_from_cart' item.id %}">
                                    <img class="cart-group-png cart-group-png2" src="{% static 'image/die.png' %}">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="item-quantity {% if not item.product.statuss or not item.is_size_available or item.quantity > item.stock_quantity %}out-of-stock{% endif %}">
                        {% if item.quantity > 1 %}
                            <a class="plus-minus minus" href="{% url 'catalog:minus_from_cart' item.id %}">-</a>
                        {% else %}
                            <p class="plus-minus minus-none">-</p>
                        {% endif %}

                        <p class="div-cart-text">{{ item.quantity }}</p>

                        {% if item.product.statuss and item.is_size_available and item.quantity < item.stock_quantity %}
                            <a class="plus-minus" href="{% url 'catalog:plus_from_cart' item.id %}">+</a>
                        {% else %}
                            <p class="plus-minus minus-none">+</p>
                        {% endif %}
                    </div>
                    <p class="cart-text-pricee">{{ item.product.summ|multiply:item.quantity|floatformat:"0" }} ‚ÇΩ</p>
                </div>
                {% endfor %}
            </div>

            <!-- –ü—Ä–∞–≤—ã–π –±–ª–æ–∫: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ -->
            <div class="cart-group cart-group2">
                <h3 class="cart-title cart-title2">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
                <div class="delivery-options-wrapper">
                    <h4 class="delivery-title">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</h4>
                    <div class="delivery-option" data-cost="0" data-method="pickup">
                        <input type="radio" id="pickup" name="delivery_method" value="pickup" checked>
                        <label for="pickup">
                            <strong>–°–∞–º–æ–≤—ã–≤–æ–∑</strong>
                            <span>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                        </label>
                    </div>
                    <h4 class="delivery-title">–ü—Ä–æ–º–æ–∫–æ–¥</h4>
                    <form id="promocode-form" method="post" action="{% url 'catalog:apply_promocode' %}" class="search-form promo-form">
                        {% csrf_token %}
                        <input type="text" class="search" name="promocode" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥..."
                               value="{% if applied_promocode %}{{ applied_promocode.code }}{% endif %}"/>
                        <button type="submit" class="search-btn under-index-new-grids-btn">
                            {% if applied_promocode %}–û–±–Ω–æ–≤–∏—Ç—å{% else %}–ü—Ä–∏–º–µ–Ω–∏—Ç—å{% endif %}
                        </button>
                    </form>
                    {% if applied_promocode %}
                    <div class="promocode-applied-group">
                        <p class="promocode-applied">–ü—Ä–∏–º–µ–Ω–µ–Ω: {{ applied_promocode.code }} (—Å–∫–∏–¥–∫–∞ {{ applied_promocode.discount_percentage }}%)</p>
                    </div>
                    {% endif %}
                </div>
                <div class="cart-summ-group">
                    <p class="cart-count">–¢–æ–≤–∞—Ä—ã, {{ total_quantity }} —à—Ç.</p>
                    <p class="cart-count">{{ total_price|floatformat:"0" }} ‚ÇΩ</p>
                </div>
                <div class="cart-summ-group">
                    <p class="cart-count">–°–∫–∏–¥–∫–∞</p>
                    <p class="cart-count cart-promo">- {{ discount_amount |floatformat:"0"}} ‚ÇΩ</p>
                </div>
                <div class="cart-summ-group">
                    <h3 class="cart-title">–ò—Ç–æ–≥–æ</h3>
                    <h3 class="cart-title cart-title-summ">{{ final_total|floatformat:"0" }} ‚ÇΩ</h3>
                </div>

                {% with unavailable_items=cart_items|filter_unavailable_items %}
                    {% if unavailable_items %}
                        <button class="buy-link-btn" disabled style="background-color: #ccc; cursor: not-allowed; border-color: #ccc; color: #666;">
                            –£–¥–∞–ª–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
                        </button>
                    {% else %}
                        <a class="buy-link-btn" href="{% url 'catalog:create_order' %}">–ó–∞–∫–∞–∑–∞—Ç—å</a>
                    {% endif %}
                {% endwith %}
            </div>
        </div>
        {% else %}
        <!-- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã —É –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="cart-big-group">
            <div class="cart-group cart-group1">
                <h3 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h3>
                <p class="cart-count">0 —Ç–æ–≤–∞—Ä–æ–≤</p>
                <div class="empty-favorites">
                    <div class="empty-icon">üõí</div>
                    <h3>–í –≤–∞—à–µ–π –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç</h3>
                    <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç–æ–≤–∞—Ä—ã, –Ω–∞–∂–∏–º–∞—è –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É</p>
                    <a href="{% url 'catalog:view_product' %}" class="browse-btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
                </div>
            </div>
            <div class="cart-group cart-group2">
                <h3 class="cart-title cart-title2">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
                <div class="empty-order">
                    <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
        <!-- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="cart-big-group">
            <div class="cart-group cart-group1" style="grid-column: 1 / -1;">
                 <h3 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h3>
                 <p class="cart-count">0 —Ç–æ–≤–∞—Ä–æ–≤</p>
                 <div class="empty-favorites">
                    <div class="empty-icon">üõí</div>
                    <h3>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ—Ä–∑–∏–Ω—É</h3>
                    <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
                    <a href="{% url 'login' %}?next={{ request.path }}" class="browse-btn">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                </div>
            </div>
        </div>
    {% endif %}
</section>
{% endblock %}

{% block page_scripts %}
<script src="{% static 'js/cart-promocode.js' %}"></script>
{% endblock %}